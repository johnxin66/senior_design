import math
from msilib import sequence
import sys
import time
import airsim

import numpy as np
import os
import tempfile
import pprint
import cv2

# sys.path.append(os.path.dirname(os.path.abspath(__file__)) +
#                 "/../path_planning/")

from path_planning.Dijkstra import Dijkstra
from path_planning.plotting import Plotting
from path_planning.multiple_stop_sequence_planner import tsp

def endSession(reset=True):
    if reset:
        client.reset()
        client.armDisarm(False)

    # that's enough fun for now. let's quit cleanly
    client.enableApiControl(False)

# _WAY_POINTS = [[0, 0, -30], [15, 15, -30], [20, 15, -30], [20, 20, -30], [25, 25, -30], [40, -30, -30], [45, 40, -30], [50, 50, -30], [50, 50, -5]]
# _TEST_DIJKSTRA_WAYPOINT_LISTS = [(900, 925), (901, 924), (902, 923), (903, 922), (904, 921), (905, 920), (906, 919), (907, 918), (908, 917), (909, 916), (910, 915), (911, 914), (912, 913), (913, 912), (914, 911), (915, 910), (916, 909), (917, 908), (918, 907), (919, 906), (920, 905), (921, 904), (922, 903), (923, 902), (924, 901), (925, 900), (926, 899), (927, 898), (928, 897), (929, 896), (930, 895), (931, 894), (932, 893), (933, 892), (934, 891), (935, 890), (936, 889), (937, 888), (938, 887), (939, 886), (940, 885), (941, 884), (942, 883), (943, 882), (944, 881), (945, 880), (946, 879), (947, 878), (948, 877), (949, 876), (950, 875), (951, 874), (952, 873), (953, 872), (954, 871), (955, 870), (956, 869), (957, 868), (958, 867), (959, 866), (960, 865), (961, 864), (962, 863), (963, 862), (964, 861), (965, 860), (966, 859), (967, 858), (967, 857), (967, 856), (967, 855), (967, 854), (967, 853), (967, 852), (967, 851), (967, 850), (967, 849), (967, 848), (967, 847), (967, 846), (967, 845), (967, 844), (967, 843), (967, 842), (967, 841), (967, 840), (967, 839), (967, 838), (967, 837), (967, 836), (967, 835), (967, 834), (967, 833), (967, 832), (967, 831), (967, 830), (967, 829), (967, 828), (967, 827), (967, 826), (967, 825), (967, 824), (967, 823), (967, 822), (967, 821), (967, 820), (967, 819), (967, 818), (967, 817), (967, 816), (967, 815), (967, 814), (967, 813), (967, 812), (967, 811), (967, 810), (967, 809), (967, 808), (967, 807), (967, 806), (967, 805), (967, 804), (967, 803), (967, 802), (967, 801), (967, 800), (967, 799), (967, 798), (967, 797), (967, 796), (967, 795), (967, 794), (967, 793), (967, 792), (967, 791), (967, 790), (967, 789), (967, 788), (967, 787), (967, 786), (967, 785), (967, 784), (967, 783), (967, 782), (967, 781), (967, 780), (967, 779), (967, 778), (967, 777), (967, 776), (967, 775), (967, 774), (967, 773), (967, 772), (967, 771), (967, 770), (967, 769), (967, 768), (967, 767), (967, 766), (967, 765), (967, 764), (967, 763), (967, 762), (967, 761), (967, 760), (967, 759), (967, 758), (967, 757), (967, 756), (967, 755), (967, 754), (967, 753), (967, 752), (967, 751), (967, 750), (967, 749), (967, 748), (967, 747), (967, 746), (967, 745), (967, 744), (967, 743), (967, 742), (967, 741), (967, 740), (967, 739), (967, 738), (967, 737), (967, 736), (967, 735), (967, 734), (967, 733), (967, 732), (967, 731), (967, 730), (967, 729), (967, 728), (967, 727), (967, 726), (967, 725), (967, 724), (967, 723), (967, 722), (967, 721), (967, 720), (967, 719), (967, 718), (967, 717), (967, 716), (967, 715), (967, 714), (967, 713), (967, 712), (967, 711), (967, 710), (967, 709), (967, 708), (967, 707), (967, 706), (967, 705), (967, 704), (967, 703), (966, 702), (965, 701), (964, 700), (963, 699), (962, 698), (961, 697), (960, 696), (959, 695), (958, 694), (957, 693), (956, 692), (955, 691), (954, 690), (953, 689), (952, 688), (951, 687), (950, 686), (949, 685), (948, 684), (947, 683), (946, 682), (945, 681), (944, 680), (943, 679), (942, 678), (941, 677), (940, 676), (939, 675), (938, 674), (938, 673), (938, 672), (938, 671), (938, 670), (938, 669), (938, 668), (938, 667), (938, 666), (938, 665), (938, 664), (938, 663), (938, 662), (938, 661), (938, 660), (938, 659), (938, 658), (938, 657), (938, 656), (938, 655), (938, 654), (938, 653), (938, 652), (938, 651), (938, 650), (938, 649), (938, 648), (938, 647), (938, 646), (938, 645), (938, 644), (938, 643), (938, 642), (938, 641), (938, 640), (938, 639), (938, 638), (938, 637), (938, 636), (938, 635), (938, 634), (938, 633), (938, 632), (938, 631), (938, 630), (938, 629), (938, 628), (938, 627), (938, 626), (938, 625), (938, 624), (938, 623), (938, 622), (938, 621), (938, 620), (938, 619), (938, 618), (938, 617), (938, 616), (938, 615), (938, 614), (938, 613), (938, 612), (938, 611), (938, 610), (938, 609), (938, 608), (938, 607), (938, 606), (938, 605), (938, 604), (938, 603), (938, 602), (938, 601), (938, 600), (938, 599), (937, 598), (936, 597), (935, 596), (934, 595), (934, 594), (934, 593), (934, 592), (934, 591), (933, 590), (932, 589), (931, 588), (930, 587), (929, 586), (928, 585), (927, 584), (926, 583), (925, 582), (924, 581), (923, 580), (922, 579), (921, 578), (920, 577), (919, 576), (918, 575), (917, 574), (916, 573), (915, 572), (914, 571), (913, 570), (912, 569), (911, 568), (910, 567), (909, 566), (908, 565), (907, 564), (906, 563), (905, 562), (904, 561), (903, 560), (902, 559), (901, 558), (900, 557), (899, 556), (898, 555), (897, 554), (896, 553), (895, 552), (894, 551), (893, 550), (892, 549), (891, 548), (890, 547), (889, 546), (888, 545), (887, 544), (886, 543), (885, 542), (884, 541), (883, 540), (882, 539), (881, 538), (880, 537), (879, 536), (878, 535), (877, 534), (876, 533), (875, 532), (874, 531), (873, 530), (872, 529), (871, 528), (870, 527), (869, 526), (868, 525), (867, 524), (866, 523), (865, 522), (864, 521), (863, 520), (862, 519), (861, 518), (860, 517), (859, 516), (858, 515), (857, 514), (856, 513), (855, 512), (854, 511), (853, 511), (852, 511), (851, 511), (850, 511), (849, 511), (848, 511), (847, 511), (846, 511), (845, 511), (844, 511), (843, 511), (842, 511), (841, 511), (840, 511), (839, 511), (838, 511), (837, 511), (836, 511), (835, 511), (834, 511), (833, 511), (832, 511), (831, 511), (830, 511), (829, 511), (828, 511), (827, 511), (826, 511), (825, 511), (824, 511), (823, 511), (822, 511), (821, 511), (820, 511), (819, 511), (818, 511), (817, 511), (816, 511), (815, 511), (814, 511), (813, 511), (812, 511), (811, 511), (810, 511), (809, 511), (808, 511), (807, 511), (806, 511), (805, 511), (804, 511), (803, 511), (802, 511), (801, 511), (800, 511), (799, 511), (798, 511), (797, 511), (796, 511), (795, 511), (794, 511), (793, 511), (792, 511), (791, 511), (790, 511), (789, 511), (788, 511), (787, 511), (786, 511), (785, 511), (784, 511), (783, 511), (782, 511), (781, 511), (780, 511), (779, 511), (778, 511), (777, 511), (776, 511), (775, 511), (774, 511), (773, 511), (772, 511), (771, 511), (770, 511), (769, 511), (768, 511), (767, 511), (766, 511), (765, 511), (764, 511), (763, 511), (762, 511), (761, 511), (760, 511), (759, 511), (758, 511), (757, 511), (756, 511), (755, 511), (754, 511), (753, 511), (752, 511), (751, 510), (750, 510), (749, 510), (748, 510), (747, 510), (746, 510), (745, 510), (744, 510), (743, 510), (742, 510), (741, 510), (740, 510), (739, 510), (738, 510), (737, 510), (736, 510), (735, 510), (734, 510), (733, 510), (732, 510), (731, 510), (730, 510), (729, 510), (728, 510), (727, 510), (726, 510), (725, 510), (724, 510), (723, 510), (722, 510), (721, 510), (720, 510), (719, 510), (718, 510), (717, 510), (716, 510), (715, 510), (714, 510), (713, 510), (712, 510), (711, 510), (710, 510), (709, 510), (708, 510), (707, 510), (706, 510), (705, 510), (704, 510), (703, 510), (702, 510), (701, 510), (700, 510), (699, 510), (698, 510), (697, 510), (696, 510), (695, 510), (694, 510), (693, 510), (692, 510), (691, 510), (690, 510), (689, 510), (688, 510), (687, 510), (686, 510), (685, 510), (684, 510), (683, 510), (682, 510), (681, 510), (680, 510), (679, 510), (678, 510), (677, 510), (676, 510), (675, 510), (674, 510), (673, 510), (672, 510), (671, 510), (670, 510), (669, 510), (668, 510), (667, 510), (666, 510), (665, 510), (664, 510), (663, 510), (662, 510), (661, 510), (660, 510), (659, 510), (658, 510), (657, 510), (656, 510), (655, 510), (654, 510), (653, 510), (652, 510), (651, 510), (650, 510), (649, 510), (648, 510), (647, 510), (646, 510), (645, 510), (644, 510), (643, 510), (642, 510), (641, 510), (640, 510), (639, 510), (638, 510), (637, 510), (636, 510), (635, 510), (634, 510), (633, 510), (632, 510), (631, 510), (630, 510), (629, 510), (628, 510), (627, 510), (626, 510), (625, 510), (624, 509), (623, 508), (622, 507), (621, 506), (620, 505), (619, 505), (618, 505), (617, 505), (616, 505), (615, 505), (614, 505), (613, 505), (612, 505), (611, 505), (610, 505), (609, 505), (608, 505), (607, 505), (606, 505), (605, 505), (604, 505), (603, 505), (602, 505), (601, 505), (600, 505), (599, 504), (598, 503), (597, 502), (596, 501), (595, 500), (594, 500), (593, 500), (592, 500), (591, 500), (590, 500), (589, 500), (588, 500), (587, 500), (586, 500), (585, 500), (584, 500), (583, 500), (582, 500), (581, 500), (580, 500), (579, 500), (578, 500), (577, 500), (576, 500), (575, 500), (574, 500), (573, 500), (572, 500), (571, 500), (570, 500), (569, 500), (568, 500), (567, 500), (566, 500), (565, 500), (564, 500), (563, 500), (562, 500), (561, 500), (560, 500), (559, 500), (558, 500), (557, 500), (556, 500), (555, 500), (554, 500), (553, 500), (552, 500), (551, 500), (550, 500), (549, 500), (548, 500), (547, 500), (546, 500), (545, 500), (544, 500), (543, 500), (542, 500), (541, 500), (540, 500), (539, 500), (538, 500), (537, 500), (536, 500), (535, 500), (534, 500), (533, 500), (532, 500), (531, 500), (530, 500), (529, 500), (528, 500), (527, 500), (526, 500), (525, 500), (524, 500), (523, 500), (522, 500), (521, 500), (520, 500), (519, 500), (518, 500), (517, 500), (516, 500), (515, 500), (514, 500), (513, 500), (512, 500), (511, 500), (510, 500), (509, 500), (508, 500), (507, 500), (506, 500), (505, 500), (504, 500), (503, 500), (502, 500), (501, 500), (500, 500)]
_TEST_DIJKSTRA_WAYPOINT_LISTS = [[(900, 925), (901, 924), (902, 923), (903, 922), (904, 921), (905, 920), (906, 919), (907, 918), (908, 917), (909, 916), (910, 915), (911, 914), (912, 913), (913, 912), (914, 911), (915, 910), (916, 909), (917, 908), (918, 907), (919, 906), (920, 905), (921, 904), (922, 903), (923, 902), (924, 901), (925, 900), (926, 899), (927, 898), (928, 897), (929, 896), (930, 895), (931, 894), (932, 893), (933, 892), (934, 891), (935, 890), (936, 889), (937, 888), (938, 887), (939, 886), (940, 885), (941, 884), (942, 883), (943, 882), (944, 881), (945, 880), (946, 879), (947, 878), (948, 877), (949, 876), (950, 875), (951, 874), (952, 873), (953, 872), (954, 871), (955, 870), (956, 869), (957, 868), (958, 867), (959, 866), (960, 865), (961, 864), (962, 863), (963, 862), (964, 861), (965, 860), (966, 859), (967, 858), (967, 857), (967, 856), (967, 855), (967, 854), (967, 853), (967, 852), (967, 851), (967, 850), (967, 849), (967, 848), (967, 847), (967, 846), (967, 845), (967, 844), (967, 843), (967, 842), (967, 841), (967, 840), (967, 839), (967, 838), (967, 837), (967, 836), (967, 835), (967, 834), (967, 833), (967, 832), (967, 831), (967, 830), (967, 829), (967, 828), (967, 827), (967, 826), (967, 825), (967, 824), (967, 823), (967, 822), (967, 821), (967, 820), (967, 819), (967, 818), (967, 817), (967, 816), (967, 815), (967, 814), (967, 813), (967, 812), (967, 811), (967, 810), (967, 809), (967, 808), (967, 807), (967, 806), (967, 805), (967, 804), (967, 803), (967, 802), (967, 801), (967, 800), (967, 799), (967, 798), (967, 797), (967, 796), (967, 795), (967, 794), (967, 793), (967, 792), (967, 791), (967, 790), (967, 789), (967, 788), (967, 787), (967, 786), (967, 785), (967, 784), (967, 783), (967, 782), (967, 781), (967, 780), (967, 779), (967, 778), (967, 777), (967, 776), (967, 775), (967, 774), (967, 773), (967, 772), (967, 771), (967, 770), (967, 769), (967, 768), (967, 767), (967, 766), (967, 765), (967, 764), (967, 763), (967, 762), (967, 761), (967, 760), (967, 759), (967, 758), (967, 757), (967, 756), (967, 755), (967, 754), (967, 753), (967, 752), (967, 751), (967, 750), (967, 749), (967, 748), (967, 747), (967, 746), (967, 745), (967, 744), (967, 743), (967, 742), (967, 741), (967, 740), (967, 739), (967, 738), (967, 737), (967, 736), (967, 735), (967, 734), (967, 733), (967, 732), (967, 731), (967, 730), (967, 729), (967, 728), (967, 727), (967, 726), (967, 725), (967, 724), (967, 723), (967, 722), (967, 721), (967, 720), (967, 719), (967, 718), (967, 717), (967, 716), (967, 715), (967, 714), (967, 713), (967, 712), (967, 711), (967, 710), (967, 709), (967, 708), (967, 707), (967, 706), (967, 705), (967, 704), (967, 703), (966, 702), (965, 701), (964, 700), (963, 699), (962, 698), (961, 697), (960, 696), (959, 695), (958, 694), (957, 693), (956, 692), (955, 691), (954, 690), (953, 689), (952, 688), (951, 687), (950, 686), (949, 685), (948, 684), (947, 683), (946, 682), (945, 681), (944, 680), (943, 679), (942, 678), (941, 677), (940, 676), (939, 675), (938, 674), (938, 673), (938, 672), (938, 671), (938, 670), (938, 669), (938, 668), (938, 667), (938, 666), (938, 665), (938, 664), (938, 663), (938, 662), (938, 661), (938, 660), (938, 659), (938, 658), (938, 657), (938, 656), (938, 655), (938, 654), (938, 653), (938, 652), (938, 651), (938, 650), (938, 649), (938, 648), (938, 647), (938, 646), (938, 645), (938, 644), (938, 643), (938, 642), (938, 641), (938, 640), (938, 639), (938, 638), (938, 637), (938, 636), (938, 635), (938, 634), (938, 633), (938, 632), (938, 631), (938, 630), (938, 629), (938, 628), (938, 627), (938, 626), (938, 625), (938, 624), (938, 623), (938, 622), (938, 621), (938, 620), (938, 619), (938, 618), (938, 617), (938, 616), (938, 615), (938, 614), (938, 613), (938, 612), (938, 611), (938, 610), (938, 609), (938, 608), (938, 607), (938, 606), (938, 605), (938, 604), (938, 603), (938, 602), (938, 601), (938, 600), (938, 599), (937, 598), (936, 597), (935, 596), (934, 595), (934, 594), (934, 593), (934, 592), (934, 591), (933, 590), (932, 589), (931, 588), (930, 587), (929, 586), (928, 585), (927, 584), (926, 583), (925, 582), (924, 581), (923, 580), (922, 579), (921, 578), (920, 577), (919, 576), (918, 575), (917, 574), (916, 573), (915, 572), (914, 571), (913, 570), (912, 569), (911, 568), (910, 567), (909, 566), (908, 565), (907, 564), (906, 563), (905, 562), (904, 561), (903, 560), (902, 559), (901, 558), (900, 557), (899, 556), (898, 555), (897, 554), (896, 553), (895, 552), (894, 551), (893, 550), (892, 549), (891, 548), (890, 547), (889, 546), (888, 545), (887, 544), (886, 543), (885, 542), (884, 541), (883, 540), (882, 539), (881, 538), (880, 537), (879, 536), (878, 535), (877, 534), (876, 533), (875, 532), (874, 531), (873, 530), (872, 529), (871, 528), (870, 527), (869, 526), (868, 525), (867, 524), (866, 523), (865, 522), (864, 521), (863, 520), (862, 519), (861, 518), (860, 517), (859, 516), (858, 515), (857, 514), (856, 513), (855, 512), (854, 511), (853, 511), (852, 511), (851, 511), (850, 511), (849, 511), (848, 511), (847, 511), (846, 511), (845, 511), (844, 511), (843, 511), (842, 511), (841, 511), (840, 511), (839, 511), (838, 511), (837, 511), (836, 511), (835, 511), (834, 511), (833, 511), (832, 511), (831, 511), (830, 511), (829, 511), (828, 511), (827, 511), (826, 511), (825, 511), (824, 511), (823, 511), (822, 511), (821, 511), (820, 511), (819, 511), (818, 511), (817, 511), (816, 511), (815, 511), (814, 511), (813, 511), (812, 511), (811, 511), (810, 511), (809, 511), (808, 511), (807, 511), (806, 511), (805, 511), (804, 511), (803, 511), (802, 511), (801, 511), (800, 511), (799, 511), (798, 511), (797, 511), (796, 511), (795, 511), (794, 511), (793, 511), (792, 511), (791, 511), (790, 511), (789, 511), (788, 511), (787, 511), (786, 511), (785, 511), (784, 511), (783, 511), (782, 511), (781, 511), (780, 511), (779, 511), (778, 511), (777, 511), (776, 511), (775, 511), (774, 511), (773, 511), (772, 511), (771, 511), (770, 511), (769, 511), (768, 511), (767, 511), (766, 511), (765, 511), (764, 511), (763, 511), (762, 511), (761, 511), (760, 511), (759, 511), (758, 511), (757, 511), (756, 511), (755, 511), (754, 511), (753, 511), (752, 511), (751, 510), (750, 510), (749, 510), (748, 510), (747, 510), (746, 510), (745, 510), (744, 510), (743, 510), (742, 510), (741, 510), (740, 510), (739, 510), (738, 510), (737, 510), (736, 510), (735, 510), (734, 510), (733, 510), (732, 510), (731, 510), (730, 510), (729, 510), (728, 510), (727, 510), (726, 510), (725, 510), (724, 510), (723, 510), (722, 510), (721, 510), (720, 510), (719, 510), (718, 510), (717, 510), (716, 510), (715, 510), (714, 510), (713, 510), (712, 510), (711, 510), (710, 510), (709, 510), (708, 510), (707, 510), (706, 510), (705, 510), (704, 510), (703, 510), (702, 510), (701, 510), (700, 510), (699, 510), (698, 510), (697, 510), (696, 510), (695, 510), (694, 510), (693, 510), (692, 510), (691, 510), (690, 510), (689, 510), (688, 510), (687, 510), (686, 510), (685, 510), (684, 510), (683, 510), (682, 510), (681, 510), (680, 510), (679, 510), (678, 510), (677, 510), (676, 510), (675, 510), (674, 510), (673, 510), (672, 510), (671, 510), (670, 510), (669, 510), (668, 510), (667, 510), (666, 510), (665, 510), (664, 510), (663, 510), (662, 510), (661, 510), (660, 510), (659, 510), (658, 510), (657, 510), (656, 510), (655, 510), (654, 510), (653, 510), (652, 510), (651, 510), (650, 510), (649, 510), (648, 510), (647, 510), (646, 510), (645, 510), (644, 510), (643, 510), (642, 510), (641, 510), (640, 510), (639, 510), (638, 510), (637, 510), (636, 510), (635, 510), (634, 510), (633, 510), (632, 510), (631, 510), (630, 510), (629, 510), (628, 510), (627, 510), (626, 510), (625, 510), (624, 509), (623, 508), (622, 507), (621, 506), (620, 505), (619, 505), (618, 505), (617, 505), (616, 505), (615, 505), (614, 505), (613, 505), (612, 505), (611, 505), (610, 505), (609, 505), (608, 505), (607, 505), (606, 505), (605, 505), (604, 505), (603, 505), (602, 505), (601, 505), (600, 505), (599, 504), (598, 503), (597, 502), (596, 501), (595, 500), (594, 500), (593, 500), (592, 500), (591, 500), (590, 500), (589, 500), (588, 500), (587, 500), (586, 500), (585, 500), (584, 500), (583, 500), (582, 500), (581, 500), (580, 500), (579, 500), (578, 500), (577, 500), (576, 500), (575, 500), (574, 500), (573, 500), (572, 500), (571, 500), (570, 500), (569, 500), (568, 500), (567, 500), (566, 500), (565, 500), (564, 500), (563, 500), (562, 500), (561, 500), (560, 500), (559, 500), (558, 500), (557, 500), (556, 500), (555, 500), (554, 500), (553, 500), (552, 500), (551, 500), (550, 500), (549, 500), (548, 500), (547, 500), (546, 500), (545, 500), (544, 500), (543, 500), (542, 500), (541, 500), (540, 500), (539, 500), (538, 500), (537, 500), (536, 500), (535, 500), (534, 500), (533, 500), (532, 500), (531, 500), (530, 500), (529, 500), (528, 500), (527, 500), (526, 500), (525, 500), (524, 500), (523, 500), (522, 500), (521, 500), (520, 500), (519, 500), (518, 500), (517, 500), (516, 500), (515, 500), (514, 500), (513, 500), (512, 500), (511, 500), (510, 500), (509, 500), (508, 500), (507, 500), (506, 500), (505, 500), (504, 500), (503, 500), (502, 500), (501, 500), (500, 500)], [(900, 500), (901, 501), (902, 502), (903, 503), (904, 504), (905, 505), (906, 506), (907, 507), (908, 508), (909, 509), (910, 510), (911, 511), (912, 512), (913, 513), (914, 514), (915, 515), (916, 516), (917, 517), (918, 518), (919, 519), (920, 520), (921, 521), (922, 522), (923, 523), (924, 524), (925, 525), (926, 526), (927, 527), (928, 528), (929, 529), (930, 530), (930, 531), (930, 532), (930, 533), (930, 534), (930, 535), (930, 536), (930, 537), (930, 538), (930, 539), (930, 540), (930, 541), (930, 542), (930, 543), (930, 544), (930, 545), (930, 546), (930, 547), (930, 548), (930, 549), (930, 550), (930, 551), (930, 552), (930, 553), (930, 554), (930, 555), (930, 556), (930, 557), (930, 558), (930, 559), (930, 560), (930, 561), (931, 562), (932, 563), (933, 564), (934, 565), (935, 566), (936, 567), (937, 568), (938, 569), (939, 570), (940, 571), (941, 572), (942, 573), (943, 574), (944, 575), (945, 576), (946, 577), (947, 578), (948, 579), (949, 580), (950, 581), (951, 582), (952, 583), (953, 584), (954, 585), (955, 586), (956, 587), (957, 588), (958, 589), (959, 590), (960, 591), (961, 592), (962, 593), (963, 594), (964, 595), (965, 596), (966, 597), (967, 598), (967, 599), (967, 600), (967, 601), (967, 602), (967, 603), (967, 604), (967, 605), (967, 606), (967, 607), (967, 608), (967, 609), (967, 610), (967, 611), (967, 612), (967, 613), (967, 614), (967, 615), (967, 616), (967, 617), (967, 618), (967, 619), (967, 620), (967, 621), (967, 622), (967, 623), (967, 624), (967, 625), (967, 626), (967, 627), (967, 628), (967, 629), (967, 630), (967, 631), (967, 632), (967, 633), (967, 634), (967, 635), (967, 636), (967, 637), (967, 638), (967, 639), (967, 640), (967, 641), (967, 642), (967, 643), (967, 644), (967, 645), (967, 646), (967, 647), (967, 648), (967, 649), (967, 650), (967, 651), (967, 652), (967, 653), (967, 654), (967, 655), (967, 656), (967, 657), (967, 658), (967, 659), (967, 660), (967, 661), (967, 662), (967, 663), (967, 664), (967, 665), (967, 666), (967, 667), (967, 668), (967, 669), (967, 670), (967, 671), (967, 672), (967, 673), (967, 674), (967, 675), (967, 676), (967, 677), (967, 678), (967, 679), (967, 680), (967, 681), (967, 682), (967, 683), (967, 684), (967, 685), (967, 686), (967, 687), (967, 688), (967, 689), (967, 690), (967, 691), (967, 692), (967, 693), (967, 694), (967, 695), (967, 696), (967, 697), (967, 698), (967, 699), (967, 700), (967, 701), (967, 702), (967, 703), (967, 704), (967, 705), (967, 706), (967, 707), (967, 708), (967, 709), (967, 710), (967, 711), (967, 712), (967, 713), (967, 714), (967, 715), (967, 716), (967, 717), (967, 718), (967, 719), (967, 720), (967, 721), (967, 722), (967, 723), (967, 724), (967, 725), (967, 726), (967, 727), (967, 728), (967, 729), (967, 730), (967, 731), (967, 732), (967, 733), (967, 734), (967, 735), (967, 736), (967, 737), (967, 738), (967, 739), (967, 740), (967, 741), (967, 742), (967, 743), (967, 744), (967, 745), (967, 746), (967, 747), (967, 748), (967, 749), (967, 750), (967, 751), (967, 752), (967, 753), (967, 754), (967, 755), (967, 756), (967, 757), (967, 758), (967, 759), (967, 760), (967, 761), (967, 762), (967, 763), (967, 764), (967, 765), (967, 766), (967, 767), (967, 768), (967, 769), (967, 770), (967, 771), (967, 772), (967, 773), (967, 774), (967, 775), (967, 776), (967, 777), (967, 778), (967, 779), (967, 780), (967, 781), (967, 782), (967, 783), (967, 784), (967, 785), (967, 786), (967, 787), (967, 788), (967, 789), (967, 790), (967, 791), (967, 792), (967, 793), (967, 794), (967, 795), (967, 796), (967, 797), (967, 798), (967, 799), (967, 800), (967, 801), (967, 802), (967, 803), (967, 804), (967, 805), (967, 806), (967, 807), (967, 808), (967, 809), (967, 810), (967, 811), (967, 812), (967, 813), (967, 814), (967, 815), (967, 816), (967, 817), (967, 818), (967, 819), (967, 820), (967, 821), (967, 822), (967, 823), (967, 824), (967, 825), (966, 826), (965, 827), (964, 828), (963, 829), (962, 830), (961, 831), (960, 832), (959, 833), (958, 834), (957, 835), (956, 836), (955, 837), (954, 838), (953, 839), (952, 840), (951, 841), (950, 842), (949, 843), (948, 844), (947, 845), (946, 846), (945, 847), (944, 848), (943, 849), (942, 850), (941, 851), (940, 852), (939, 853), (938, 854), (937, 855), (936, 856), (935, 857), (934, 858), (933, 859), (932, 860), (931, 861), (930, 862), (929, 863), (928, 864), (927, 865), (926, 866), (925, 867), (924, 868), (923, 869), (922, 870), (921, 871), (920, 872), (919, 873), (918, 874), (917, 875), (916, 876), (915, 877), (914, 878), (913, 879), (912, 880), (911, 881), (910, 882), (909, 883), (908, 884), (907, 885), (906, 886), (905, 887), (904, 888), (903, 889), (902, 890), (901, 891), (900, 892), (900, 893), (900, 894), (900, 895), (900, 896), (900, 897), (900, 898), (900, 899), (900, 900), (900, 901), (900, 902), (900, 903), (900, 904), (900, 905), (900, 906), (900, 907), (900, 908), (900, 909), (900, 910), (900, 911), (900, 912), (900, 913), (900, 914), (900, 915), (900, 916), (900, 917), (900, 918), (900, 919), (900, 920), (900, 921), (900, 922), (900, 923), (900, 924), (900, 925)], [(500, 500), (501, 500), (502, 500), (503, 500), (504, 500), (505, 500), (506, 500), (507, 500), (508, 500), (509, 500), (510, 500), (511, 500), (512, 500), (513, 500), (514, 500), (515, 500), (516, 500), (517, 500), (518, 500), (519, 500), (520, 500), (521, 500), (522, 500), (523, 500), (524, 500), (525, 500), (526, 500), (527, 500), (528, 500), (529, 500), (530, 500), (531, 500), (532, 500), (533, 500), (534, 500), (535, 500), (536, 500), (537, 500), (538, 500), (539, 500), (540, 500), (541, 500), (542, 500), (543, 500), (544, 500), (545, 500), (546, 500), (547, 500), (548, 500), (549, 500), (550, 500), (551, 500), (552, 500), (553, 500), (554, 500), (555, 500), (556, 500), (557, 500), (558, 500), (559, 500), (560, 500), (561, 500), (562, 500), (563, 500), (564, 500), (565, 500), (566, 500), (567, 500), (568, 500), (569, 500), (570, 500), (571, 500), (572, 500), (573, 500), (574, 500), (575, 500), (576, 500), (577, 500), (578, 500), (579, 500), (580, 500), (581, 500), (582, 500), (583, 500), (584, 500), (585, 500), (586, 500), (587, 500), (588, 500), (589, 500), (590, 500), (591, 500), (592, 500), (593, 500), (594, 500), (595, 500), (596, 500), (597, 500), (598, 500), (599, 500), (600, 500), (601, 500), (602, 500), (603, 500), (604, 500), (605, 500), (606, 500), (607, 500), (608, 500), (609, 500), (610, 500), (611, 500), (612, 500), (613, 500), (614, 500), (615, 500), (616, 500), (617, 500), (618, 500), (619, 500), (620, 500), (621, 500), (622, 500), (623, 500), (624, 500), (625, 500), (626, 500), (627, 500), (628, 500), (629, 500), (630, 500), (631, 500), (632, 500), (633, 500), (634, 500), (635, 500), (636, 500), (637, 500), (638, 500), (639, 500), (640, 500), (641, 500), (642, 500), (643, 500), (644, 500), (645, 500), (646, 500), (647, 500), (648, 500), (649, 500), (650, 500), (651, 500), (652, 500), (653, 500), (654, 500), (655, 500), (656, 500), (657, 500), (658, 500), (659, 500), (660, 500), (661, 500), (662, 500), (663, 500), (664, 500), (665, 500), (666, 500), (667, 500), (668, 500), (669, 500), (670, 500), (671, 500), (672, 500), (673, 500), (674, 500), (675, 500), (676, 500), (677, 500), (678, 500), (679, 500), (680, 500), (681, 500), (682, 500), (683, 500), (684, 500), (685, 500), (686, 500), (687, 500), (688, 500), (689, 500), (690, 500), (691, 500), (692, 500), (693, 500), (694, 500), (695, 500), (696, 500), (697, 500), (698, 500), (699, 500), (700, 500), (701, 500), (702, 500), (703, 500), (704, 500), (705, 500), (706, 500), (707, 500), (708, 500), (709, 500), (710, 500), (711, 500), (712, 500), (713, 500), (714, 500), (715, 500), (716, 500), (717, 500), (718, 500), (719, 500), (720, 500), (721, 500), (722, 500), (723, 500), (724, 500), (725, 500), (726, 500), (727, 500), (728, 500), (729, 500), (730, 500), (731, 500), (732, 500), (733, 500), (734, 500), (735, 500), (736, 500), (737, 500), (738, 500), (739, 500), (740, 500), (741, 500), (742, 500), (743, 500), (744, 500), (745, 500), (746, 500), (747, 500), (748, 500), (749, 500), (750, 500), (751, 500), (752, 500), (753, 500), (754, 500), (755, 500), (756, 500), (757, 500), (758, 500), (759, 500), (760, 500), (761, 500), (762, 500), (763, 500), (764, 500), (765, 500), (766, 500), (767, 500), (768, 500), (769, 500), (770, 500), (771, 500), (772, 500), (773, 500), (774, 500), (775, 500), (776, 500), (777, 500), (778, 500), (779, 500), (780, 500), (781, 500), (782, 500), (783, 500), (784, 500), (785, 500), (786, 500), (787, 500), (788, 500), (789, 500), (790, 500), (791, 500), (792, 500), (793, 500), (794, 500), (795, 500), (796, 500), (797, 500), (798, 500), (799, 500), (800, 500), (801, 500), (802, 500), (803, 500), (804, 500), (805, 500), (806, 500), (807, 500), (808, 500), (809, 500), (810, 500), (811, 500), (812, 500), (813, 500), (814, 500), (815, 500), (816, 500), (817, 500), (818, 500), (819, 500), (820, 500), (821, 500), (822, 500), (823, 500), (824, 500), (825, 500), (826, 500), (827, 500), (828, 500), (829, 500), (830, 500), (831, 500), (832, 500), (833, 500), (834, 500), (835, 500), (836, 500), (837, 500), (838, 500), (839, 500), (840, 500), (841, 500), (842, 500), (843, 500), (844, 500), (845, 500), (846, 500), (847, 500), (848, 500), (849, 500), (850, 500), (851, 500), (852, 500), (853, 500), (854, 500), (855, 500), (856, 500), (857, 500), (858, 500), (859, 500), (860, 500), (861, 500), (862, 500), (863, 500), (864, 500), (865, 500), (866, 500), (867, 500), (868, 500), (869, 500), (870, 500), (871, 500), (872, 500), (873, 500), (874, 500), (875, 500), (876, 500), (877, 500), (878, 500), (879, 500), (880, 500), (881, 500), (882, 500), (883, 500), (884, 500), (885, 500), (886, 500), (887, 500), (888, 500), (889, 500), (890, 500), (891, 500), (892, 500), (893, 500), (894, 500), (895, 500), (896, 500), (897, 500), (898, 500), (899, 500), (900, 500)]]
_CORRECTION = 0

s_start = (500, 500)
s_goals = [(900, 925), (900, 500)]#, (400, 425)]

# Generate stop sequence, which is circular by nature
s_goals.insert(0, s_start)
_, stop_sequence = tsp(s_goals)

# rotate the stop sequence to start from s_start
stop_sequence = stop_sequence[:-1]
i_start = stop_sequence.index(0)
stop_sequence = stop_sequence[i_start:] + stop_sequence[:i_start] + [0]
print("stop_sequence", stop_sequence)

# generate path among the sequence of stops
# _TEST_DIJKSTRA_WAYPOINT_LISTS = []
# for i_stop in range(len(stop_sequence) - 1):
#     dijkstra = Dijkstra(s_goals[stop_sequence[i_stop]], s_goals[stop_sequence[i_stop + 1]])
#     curr_waypoints, _ = dijkstra.searching()
#     _TEST_DIJKSTRA_WAYPOINT_LISTS.append(curr_waypoints)
# print("_TEST_DIJKSTRA_WAYPOINT_LISTS")
# print(_TEST_DIJKSTRA_WAYPOINT_LISTS)

# connect to the AirSim simulator
client = airsim.MultirotorClient(timeout_value=10)
client.confirmConnection()
client.reset()
client.enableApiControl(True)

state = client.getMultirotorState()
s = pprint.pformat(state)
print("state: %s" % s)
# initial_location_xyz = state.position.x_val, state.position.y_val, state.position.z_val

imu_data = client.getImuData()
s = pprint.pformat(imu_data)
print("imu_data: %s" % s)

barometer_data = client.getBarometerData()
s = pprint.pformat(barometer_data)
print("barometer_data: %s" % s)

magnetometer_data = client.getMagnetometerData()
s = pprint.pformat(magnetometer_data)
print("magnetometer_data: %s" % s)

gps_data = client.getGpsData()
s = pprint.pformat(gps_data)
print("gps_data: %s" % s)

airsim.wait_key('Press any key to takeoff')
print("Taking off...")
client.armDisarm(True)
client.takeoffAsync().join()

state = client.getMultirotorState()
print("state: %s" % pprint.pformat(state))

airsim.wait_key('Press any key to move vehicle to the destination at 5 m/s')
print("Flying...")
current_xy = 0, 0, -50
for waypoints in _TEST_DIJKSTRA_WAYPOINT_LISTS:
    i = 0
    for waypoint in reversed(waypoints):
        i += 1
        if i > 1 and i <= len(waypoints) - 1:
            prev = waypoints[i - 2]
            curr = waypoints[i - 1]
            next = waypoints[i]
            if (curr[0] - prev[0] == next[0] - curr[0] and curr[1] - prev[1] == next[1] - curr[1]):
                continue
        new_waypoint = -(waypoint[0] - 500), -(waypoint[1] + _CORRECTION - 500), -50
        # current_position = current_xy[0], current_xy[1]
        yaw = 0 #math.degrees(math.atan2(current_xy[1] - new_waypoint[1], current_xy[0] - new_waypoint[0]))
        # print("new_waypoint:", new_waypoint)
        # print("current_xy:", current_xy)
        # print("vector to new waypoint:", current_xy[1] - new_waypoint[1])
        # print(f"yaw degree: {yaw}")
        yaw_mode = airsim.YawMode(is_rate=False, yaw_or_rate=yaw)
        move_future = client.moveToPositionAsync(new_waypoint[0], new_waypoint[1], new_waypoint[2], 10, drivetrain=airsim.DrivetrainType.ForwardOnly, yaw_mode=yaw_mode)
        while not move_future._set_flag:
            move_future._loop.start()
            distance_sensor_data = client.getDistanceSensorData()
            # dd = pprint.pformat(distance_sensor_data)
            # print("distance_sensor_data: %s" % dd)
            if (distance_sensor_data.distance < 20):
                client.cancelLastTask()
                client.hoverAsync().join()
                exit()

        move_future.join()
        # client.hoverAsync().join()
        # time.sleep(8)

        current_pose = client.simGetVehiclePose().position
        current_xy = current_pose.x_val, current_pose.y_val

    # Descend and hover for dropoff

    client.hoverAsync().join()
    client.moveToPositionAsync(-(waypoints[0][0] - 500), -(waypoints[0][1] + _CORRECTION - 500), -5, 10).join()
    state = client.getMultirotorState()
    print("state: %s" % pprint.pformat(state))

# airsim.wait_key('Press any key to take images')
# # get camera images from the car
# responses = client.simGetImages([
#     airsim.ImageRequest("0", airsim.ImageType.DepthVis),  #depth visualization image
#     airsim.ImageRequest("1", airsim.ImageType.DepthPerspective, True), #depth in perspective projection
#     airsim.ImageRequest("1", airsim.ImageType.Scene), #scene vision image in png format
#     airsim.ImageRequest("1", airsim.ImageType.Scene, False, False)])  #scene vision image in uncompressed RGBA array
# print('Retrieved images: %d' % len(responses))

# tmp_dir = os.path.join(tempfile.gettempdir(), "airsim_drone")
# print ("Saving images to %s" % tmp_dir)
# try:
#     os.makedirs(tmp_dir)
# except OSError:
#     if not os.path.isdir(tmp_dir):
#         raise

# for idx, response in enumerate(responses):

#     filename = os.path.join(tmp_dir, str(idx))

#     if response.pixels_as_float:
#         print("Type %d, size %d" % (response.image_type, len(response.image_data_float)))
#         airsim.write_pfm(os.path.normpath(filename + '.pfm'), airsim.get_pfm_array(response))
#     elif response.compress: #png format
#         print("Type %d, size %d" % (response.image_type, len(response.image_data_uint8)))
#         airsim.write_file(os.path.normpath(filename + '.png'), response.image_data_uint8)
#     else: #uncompressed array
#         print("Type %d, size %d" % (response.image_type, len(response.image_data_uint8)))
#         img1d = np.fromstring(response.image_data_uint8, dtype=np.uint8) # get numpy array
#         img_rgb = img1d.reshape(response.height, response.width, 3) # reshape array to 4 channel image array H X W X 3
#         cv2.imwrite(os.path.normpath(filename + '.png'), img_rgb) # write to png

airsim.wait_key('Press any key to reset to original state')
endSession()

